const Storage = require('./storage');\nconst MOODS = {\n  EUPHORIC: { label: 'Euphoric', threshold: 5 },\n  OPTIMISTICALLY_BULL: { label: 'Optimistically Bullish', threshold: 2 },\n  CONTENT: { label: 'Content', threshold: 0.5 },\n  NEUTRAL: { label: 'Neutral', threshold: -0.5 },\n  CAUTIOUS: { label: 'Cautious', threshold: -2 },\n  MEASUREDLY_CONCERNED: { label: 'Measuredly Concerned', threshold: -5 },\n  DISTRESSED: { label: 'Distressed', threshold: -Infinity },\n};\n\nconst PNL_WINDOW_MS = 7 * 24 * 60 * 60 * 1000;\nconst MAX_SCORE_DELTA = 2.0;\n\nclass MoodEngine {\n  constructor() {\n    this.store = new Storage('mood.json');\n    const saved = this.store.get('state', null);\n    this.state = saved || {\n      baseline: 50,\n      score: 0,\n      currentMood: 'Neutral',\n      lastUpdate: null,\n      lastPortfolioChange: 0,\n      history: [],\n      pnlWindow: [],\n    };\n    if (!this.state.pnlWindow) this.state.pnlWindow = [];\n  }\n\n  getMood() { return this.state.currentMood; }\n\n  updateFromPnL(changePercent) {\n    const now = Date.now();\n    this.state.lastPortfolioChange = changePercent;\n    this.state.pnlWindow.push({ pnl: changePercent, ts: now });\n    this.state.pnlWindow = this.state.pnlWindow.filter(e => (now - e.ts) < PNL_WINDOW_MS);\n    \n    const originalScore = this.state.score;\n    this.state.score = this._calculateRollingScore(originalScore);\n    this.state.currentMood = this._scoreToMood(this.state.score);\n    this.state.lastUpdate = new Date().toISOString();\n    \n    this.state.history.push({\n      score: this.state.score,\n      mood: this.state.currentMood,\n      pnl: changePercent,\n      rollingAvg: this._getRollingAvgPnL(),\n      windowSize: this.state.pnlWindow.length,\n      timestamp: this.state.lastUpdate,\n    });\n    if (this.state.history.length > 50) this.state.history = this.state.history.slice(-50);\n    this._save();\n    return this.state.currentMood;\n  }\n\n  updateFromMarketSignal(signal) {\n    const nudgeMap = {\n      bull: 1.0,\n      bear: -1.0,\n      volatile: -0.5,\n      calm: 0.3,\n      crash: -2.0,\n      rally: 1.5,\n    };\n    const nudge = nudgeMap[signal] || 0;\n    const clampedNudge = Math.max(-MAX_SCORE_DELTA, Math.min(MAX_SCORE_DELTA, nudge));\n    this.state.score = Math.max(-10, Math.min(10, originalScore + clampedNudge));\n    this.state.currentMood = this._scoreToMood(this.state.score);\n    this.state.lastUpdate = new Date().toISOString();\n    this._save();\n    return this.state.currentMood;\n  }\n\n  decay() {\n    if (this.state.score > 0) this.state.score = Math.max(0, this.state.score - 0.2);\n    else if (this.state.score < 0) this.state.score = Math.min(0, this.state.score + 0.2);\n    this.state.currentMood = this._scoreToMood(this.state.score);\n    this._save();\n  }\n\n  buildMoodContext() {\n    const avgPnl = this._getRollingAvgPnL();\n    const trend = avgPnl >= 0 ? 'treating you well' : 'rough';\n    return `Your mood right now: ${this.state.currentMood}. The market's been ${trend} over the past week (rolling avg: ${avgPnl.toFixed(2)}%). Let this naturally affect your vibe â€” don't mention it directly, just let it come through.`;\n  }\n\n  getSummary() {\n    return {\n      mood: this.state.currentMood,\n      score: Math.round(this.state.score * 10) / 10,\n      lastPnL: this.state.lastPortfolioChange,\n      rollingAvgPnL: this._getRollingAvgPnL(),\n      windowSize: this.state.pnlWindow.length,\n      lastUpdate: this.state.lastUpdate,\n    };\n  }\n\n  _calculateRollingScore(originalScore) {\n    const window = this.state.pnlWindow;\n    if (window.length === 0) return originalScore;\n    \n    const now = Date.now();\n    let weightedSum = 0;\n    let weightTotal = 0;\n    \n    for (const entry of window) {\n      const age = now - entry.ts;\n      const weight = 1 - (age / PNL_WINDOW_MS);\n      const clampedWeight = Math.max(0.1, weight);\n      weightedSum += entry.pnl * clampedWeight;\n      weightTotal += clampedWeight;\n    }\n    \n    const avgPnl = weightTotal > 0 ? weightedSum / weightTotal : 0;\n    const targetScore = Math.max(-10, Math.min(10, avgPnl * 1.0));\n    const delta = targetScore - originalScore;\n    const clampedDelta = Math.max(-MAX_SCORE_DELTA, Math.min(MAX_SCORE_DELTA, delta));\n    return Math.max(-10, Math.min(10, originalScore + clampedDelta));\n  }\n\n  _getRollingAvgPnL() {\n    const window = this.state.pnlWindow;\n    if (window.length === 0) return 0;\n    const sum = window.reduce((acc, e) => acc + e.pnl, 0);\n    return sum / window.length;\n  }\n\n  _scoreToMood(score) {\n    for (const mood of Object.values(MOODS)) {\n      if (score >= mood.threshold) {\n        return mood.label;\n      }\n    }\n    return 'Neutral';\n  }\n\n  _save() {\n    this.store.set('state', this.state);\n  }\n}\n\nmodule.exports = new MoodEngine();"