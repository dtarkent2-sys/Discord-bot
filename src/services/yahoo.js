const BatchFallbackWarning = "WARNING: Batch quote endpoint failed; falling back to individual fetches. Some results may be delayed or incomplete for large queries.";const getQuotes=(tickers)=>{if(!tickers||tickers.length===0)return Promise.resolve([]);const symbols=tickers.map(t=>t.toUpperCase()).join(',');return new Promise(async(resolve)=>{try{const data=await new Promise((resolve,reject)=>{const url=new URL('https://financialmodelingprep.com/stable/batch-quote');url.searchParams.set('apikey',process.env.FMP_API_KEY||'');url.searchParams.set('symbols',symbols);fetch(url.toString(),{headers:{'Accept':'application/json'},signal:AbortSignal.timeout(15000)}).then(r=>r.ok?r.json().catch(()=>resolve([])):(reject(new Error(`FMP API ${r.status}`)))}.catch(err=>{console.error('[FMP] Batch quote error:',err.message);reject(err)});if(!Array.isArray(data))data=[data];const results=data.filter(Boolean).map(q=>({symbol:q.symbol,shortName:q.name,regularMarketPrice:q.price,regularMarketPreviousClose:q.previousClose,regularMarketVolume:q.volume,regularMarketChange:q.change,regularMarketChangePercent:q.changesPercentage,marketCap:q.marketCap}));const needed=tickers.map(t=>t.toUpperCase());const pending=needed.filter(t=>!results.some(r=>r.symbol===t));if(pending.length>0){console.warn(`[FMP] Batch fallback active due to missing symbols: ${pending.join(', ')}`);const missingResults=[];for(const t of pending){try{const q=await this.getQuote(t);missingResults.push(q)}catch(e){missingResults.push({symbol:t,error:e.message})}}}const finalResults=[...results,...missingResults];resolve(finalResults)}catch(err){console.error('[FMP] Batch fetch failed:',err.message);const results=[];for(const t of tickers){try{results.push(await this.getQuote(t))}catch(e){results.push({symbol:t.toUpperCase(),error:e.message})}}}console.warn(BatchFallbackWarning);resolve(results)}};const originalGetQuotes=MarketDataClient.prototype.getQuotes.bind(MarketDataClient.prototype);Object.assign(MarketDataClient.prototype,{getQuotes(tickers){const tickersArray=tickers;if(!Array.isArray(tickersArray))tickersArray=[tickersArray];const count=tickersArray.length;if(count>1){const symbolsArray=tickersArray.map(t=>t.toUpperCase());const missing=symbolsArray.filter(s=>!batchFallbackCache[s]);if(missing.length>0){console.warn(`[FMP] Missing symbols in batch attempt: ${missing.join(', ')}`)}if(tickersArray.length>5){console.warn(`${BatchFallbackWarning} (truncated for ${tickersArray.length} symbols)`)}}return originalGetQuotes(tickersArray)}});module.exports=MarketDataClient;