before = \;[MarketDataClient{\ninstance?[\n  description?("Market data client using Financial Modeling Prep (FMP) API.")]\n  config?[\n    fmpApiKey?("")\n  ]\n  CRYPTO_MAP?(\n    BTC("BTCUSD"),\n    ETH("ETHUSD"),\n    SOL("SOLUSD"),\n    XRP("XRPUSD"),\n    DOGE("DOGEUSD"),\n    ADA("ADAUSD"),\n    AVAX("AVAXUSD"),\n    DOT("DOTUSD"),\n    LINK("LINKUSD"),\n    MATIC("MATICUSD"),\n    SHIB("SHIBUSD"),\n    LTC("LTCUSD"),\n    BNB("BNBUSD"),\n    ATOM("ATOMUSD"),\n    UNI("UNIUSD"),\n    FIL("FILUSD"),\n    APT("APTUSD"),\n    ARB("ARBUSD"),\n    OP("OPUSD"),\n    NEAR("NEARUSD"),\n    SUI("SUIUSD"),\n    SEI("SEIUSD"),\n    TIA("TIAUSD"),\n    INJ("INJUSD"),\n    PEPE("PEPEUSD"),\n    WIF("WIFUSD"),\n    BONK("BONKUSD"),\n    FLOKI("FLOKIUSD"),\n    RENDER("RENDERUSD"),\n    FET("FETUSD"),\n    TAO("TAOUSD"),\n    HBAR("HBARUSD"),\n    ALGO("ALGOUSD"),\n    XLM("XLMUSD"),\n    VET("VETUSD"),\n    ICP("ICPUSD"),\n    AAVE("AAVEUSD"),\n    MKR("MKRUSD"),\n    CRV("CRVUSD"),\n    SAND("SANDUSD"),\n    MANA("MANAUSD"),\n    AXS("AXSUSD"),\n    GALA("GALAUSD"),\n    IMX("IMXUSD")\n  )]\n  FMP_BASE?("https://financialmodelingprep.com/stable")\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== \"string\"?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?= q.volume\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from}), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{console.warn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{console.warn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console.warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console.warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[\,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(`**Price:** $${quote.regularMarketPrice.toFixed(2)}`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}`)\n    if(quote.marketCap) lines.push(`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes||quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `**Screen Results** (${quotes.length} stocks)\n\\`\\`\\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n}\n\nmodule.exports?= new MarketDataClient();\n"; after = \;[MarketDataClient{\ninstance?[\ndescription?("Market data client using Financial Modeling Prep (FMP) API.")\nconfig?[\n  fmpApiKey?("")\n]\nCRYPTO_MAP?(\n  BTC(\"BTCUSD\"),\n  ETH(\"ETHUSD\"),\n...\n)\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== \"string\"?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?= q.volume\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from}), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{console.warn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{console.warn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console.warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console.warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[\,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(`**Price:** $${quote.regularMarketPrice.toFixed(2)}`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}`)\n    if(quote.marketCap) lines.push(`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes||quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `**Screen Results** (${quotes.length} stocks)\n\\`\\`\\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n\}\n\nmodule.exports?= new MarketDataClient();\nREGISTER_POST_PROCESS_HOOK?({"eventHandlers?[{\nname?(\"messageCreate\")\nchannelFilter?([])\nsyntax?([/^!price\\s+(.+)$/i,])\npriority?(10)\nrun?((bot, message, match) => {\n  const ticker?= match[1]?.trim()\n  if(!ticker) return\n  const client?= bot.services.get(\"yahoo-market-data\")\n  if(!client?.enabled) return message.reply(\"Market data is disabled. Check FMP_API_KEY.\")\n  client?.getQuote(ticker)\n    .then(quote=>{\n      if(!quote) return message.reply(\"No data found.\")\n      const embed?= {\n        title?= `${quote.symbol} - ${quote.shortName}`\n        description?= `Price: $${quote.regularMarketPrice?.toFixed(2) || 0}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%`\n        color?= 0x4CAF50\n      }\n      message.channel.send({embeds:[embed]})\n    })\n    .catch(err=>{\n      bot.logger?.warn?.(\`[Command] Invalid ticker \${ticker}: \${err.message}\`)\n      message.reply(\"Failed to fetch price. Check the ticker symbol or try later.\")\n    })\n})}]\n})]};\n\n// Sanitize ticker with clearer errors\nfunction sanitizeTicker(ticker) {\n  try {\n    if (!ticker || typeof ticker !== 'string') throw new Error('Invalid ticker: must be a string');\n    const cleaned = ticker.replace(/[^A-Za-z0-9.\-]/g, '').trim();\n    if (!cleaned) throw new Error('Invalid ticker: empty after cleaning');\n    if (cleaned.length > 12) throw new Error('Invalid ticker: too long (max 12 chars)');\n    return cleaned.toUpperCase();\n  } catch (err) {\n    console.warn('[sanitizeTicker] Invalid input:', ticker, err.message);\n    return { error: err.message, value: null };\n  }\n}\n// Replace old implementation\nconst MarketDataClient = require('./MarketDataClient');\nMarketDataClient.prototype.sanitizeTicker = function(ticker) {\n  const result = sanitizeTicker(ticker);\n  if (result.error) {\n    console.warn(`[FMP] Input validation failed for ticker \${ticker}: \${result.error}`);\n    return { error: result.error, value: null };\n  }\n  return { error: null, value: result.value };\n};\n\n// Ensure retry wrapper logs failures explicitly\nconst originalRetry = MarketDataClient.prototype._retry;\nMarketDataClient.prototype._retry = function(fn, label, maxRetries = 2) {\n  try {\n    return originalRetry.call(this, fn, label, maxRetries);\n  } catch (err) {\n    console.error(`[FMP] Retry failed for ${label}:`, err.message);\n    throw err;\n  }\n};\n\n// Monkey-patch search to log empty queries\nconst originalSearch = MarketDataClient.prototype.search;\nMarketDataClient.prototype.search = function(query) {\n  if (!query || query.trim().length === 0) {\n    console.warn('[FMP] Empty search query received');\n  }\n  return originalSearch.call(this, query);\n};\n\n// Add debug mode toggle for development\nprocess.env.DEBUG_FMP? && !process.env.DEBUG_FMP?.toLowerCase().includes('false')? {}\n: { debugMode: false };\n\n// Final export\nmodule.exports = new MarketDataClient();\n\n// Health check endpoint for orchestration\nif (require.main === module) {\n  console.log('[MarketDataClient] Initialized successfully');\n  console.log(`[MarketDataClient] Enabled: ${new MarketDataClient().enabled}`);\n}"); after = \;[MarketDataClient{\ninstance?[\n  description?(\"Market data client using Financial Modeling Prep (FMP) API.\")\n  config?[\n    fmpApiKey?(\"\")\n  ]\n  CRYPTO_MAP?(\n    BTC(\"BTCUSD\"),\n    ETH(\"ETHUSD\"),\n    SOL(\"SOLUSD\"),\n    XRP(\"XRPUSD\"),\n    DOGE(\"DOGEUSD\"),\n    ADA(\"ADAUSD\"),\n    AVAX(\"AVAXUSD\"),\n    DOT(\"DOTUSD\"),\n    LINK(\"LINKUSD\"),\n    MATIC(\"MATICUSD\"),\n    SHIB(\"SHIBUSD\"),\n    LTC(\"LTCUSD\"),\n    BNB(\"BNBUSD\"),\n    ATOM(\"ATOMUSD\"),\n    UNI(\"UNIUSD\"),\n    FIL(\"FILUSD\"),\n    APT(\"APTUSD\"),\n    ARB(\"ARBUSD\"),\n    OP(\"OPUSD\"),\n    NEAR(\"NEARUSD\"),\n    SUI(\"SUIUSD\"),\n    SEI(\"SEIUSD\"),\n    TIA(\"TIAUSD\"),\n    INJ(\"INJUSD\"),\n    PEPE(\"PEPEUSD\"),\n    WIF(\"WIFUSD\"),\n    BONK(\"BONKUSD\"),\n    FLOKI(\"FLOKIUSD\"),\n    RENDER(\"RENDERUSD\"),\n    FET(\"FETUSD\"),\n    TAO(\"TAOUSD\"),\n    HBAR(\"HBARUSD\"),\n    ALGO(\"ALGOUSD\"),\n    XLM(\"XLMUSD\"),\n    VET(\"VETUSD\"),\n    ICP(\"ICPUSD\"),\n    AAVE(\"AAVEUSD\"),\n    MKR(\"MKRUSD\"),\n    CRV(\"CRVUSD\"),\n    SAND(\"SANDUSD\"),\n    MANA(\"MANAUSD\"),\n    AXS(\"AXSUSD\"),\n    GALA(\"GALAUSD\"),\n    IMX(\"IMXUSD\")\n  )]\n  FMP_BASE?(\"https://financialmodelingprep.com/stable\")\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== 'string'?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?= q.volume\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from}), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{console.warn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{console.warn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console.warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console.warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[\,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(`**Price:** $${quote.regularMarketPrice.toFixed(2)}`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}`)\n    if(quote.marketCap) lines.push(`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes||quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `**Screen Results** (${quotes.length} stocks)\n\\`\\`\\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n}\n\nmodule.exports?= new MarketDataClient();\nREGISTER_POST_PROCESS_HOOK?({"eventHandlers?[{\nname?(\"messageCreate\")\nchannelFilter?([])\nsyntax?([/^!price\\s+(.+)$/i,])\npriority?(10)\nrun?((bot, message, match) => {\n  const ticker?= match[1]?.trim()\n  if(!ticker) return\n  const client?= bot.services.get(\"yahoo-market-data\")\n  if(!client?.enabled) return message.reply(\"Market data is disabled. Check FMP_API_KEY.\")\n  client?.getQuote(ticker)\n    .then(quote=>{\n      if(!quote) return message.reply(\"No data found.\")\n      const embed?= {\n        title?= `${quote.symbol} - ${quote.shortName}`\n        description?= `Price: $${quote.regularMarketPrice?.toFixed(2) || 0}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%`\n        color?= 0x4CAF50\n      }\n      message.channel.send({embeds:[embed]})\n    })\n    .catch(err=>{\n      bot.logger?.warn?.(\`[Command] Invalid ticker \${ticker}: \${err.message}\`)\n      message.reply(\"Failed to fetch price. Check the ticker symbol or try later.\")\n    })\n})}]\n})]};\n\n// Sanitize ticker with clearer errors\nfunction sanitizeTicker(ticker) {\n  try {\n    if (!ticker || typeof ticker !== 'string') throw new Error('Invalid ticker: must be a string');\n    const cleaned = ticker.replace(/[^A-Za-z0-9.\-]/g, '').trim();\n    if (!cleaned) throw new Error('Invalid ticker: empty after cleaning');\n    if (cleaned.length > 12) throw new Error('Invalid ticker: too long (max 12 chars)');\n    return cleaned.toUpperCase();\n  } catch (err) {\n    console.warn('[sanitizeTicker] Invalid input:', ticker, err.message);\n    return { error: err.message, value: null };\n  }\n}\n// Replace old implementation\nconst MarketDataClient = require('./MarketDataClient');\nMarketDataClient.prototype.sanitizeTicker = function(ticker) {\n  const result = sanitizeTicker(ticker);\n  if (result.error) {\n    console.warn(`[FMP] Input validation failed for ticker \${ticker}: \${result.error}`);\n    return { error: result.error, value: null };\n  }\n  return { error: null, value: result.value };\n};\n\n// Ensure retry wrapper logs failures explicitly\nconst originalRetry = MarketDataClient.prototype._retry;\nMarketDataClient.prototype._retry = function(fn, label, maxRetries = 2) {\n  try {\n    return originalRetry.call(this, fn, label, maxRetries);\n  } catch (err) {\n    console.error(`[FMP] Retry failed for ${label}:`, err.message);\n    throw err;\n  }\n};\n\n// Monkey-patch search to log empty queries\nconst originalSearch = MarketDataClient.prototype.search;\nMarketDataClient.prototype.search = function(query) {\n  if (!query || query.trim().length === 0) {\n    console.warn('[FMP] Empty search query received');\n  }\n  return originalSearch.call(this, query);\n};\n\n// Add debug mode toggle for development\nprocess.env.DEBUG_FMP? && !process.env.DEBUG_FMP?.toLowerCase().includes('false')? {}\n: { debugMode: false };\n\n// Final export\nmodule.exports = new MarketDataClient();\n\n// Health check endpoint for orchestration\nif (require.main === module) {\n  console.log('[MarketDataClient] Initialized successfully');\n  console.log(`[MarketDataClient] Enabled: ${new MarketDataClient().enabled}`);\n}"); after = \;[MarketDataClient{\ninstance?[\n  description?(\"Market data client using Financial Modeling Prep (FMP) API.\")\n  config?[\n    fmpApiKey?(\"\")\n  ]\n  CRYPTO_MAP?(\n    BTC(\"BTCUSD\"),\n    ETH(\"ETHUSD\"),\n    SOL(\"SOLUSD\"),\n    XRP(\"XRPUSD\"),\n    DOGE(\"DOGEUSD\"),\n    ADA(\"ADAUSD\"),\n    AVAX(\"AVAXUSD\"),\n    DOT(\"DOTUSD\"),\n    LINK(\"LINKUSD\"),\n    MATIC(\"MATICUSD\"),\n    SHIB(\"SHIBUSD\"),\n    LTC(\"LTCUSD\"),\n    BNB(\"BNBUSD\"),\n    ATOM(\"ATOMUSD\"),\n    UNI(\"UNIUSD\"),\n    FIL(\"FILUSD\"),\n    APT(\"APTUSD\"),\n    ARB(\"ARBUSD\"),\n    OP(\"OPUSD\"),\n    NEAR(\"NEARUSD\"),\n    SUI(\"SUIUSD\"),\n    SEI(\"SEIUSD\"),\n    TIA(\"TIAUSD\"),\n    INJ(\"INJUSD\"),\n    PEPE(\"PEPEUSD\"),\n    WIF(\"WIFUSD\"),\n    BONK(\"BONKUSD\"),\n    FLOKI(\"FLOKIUSD\"),\n    RENDER(\"RENDERUSD\"),\n    FET(\"FETUSD\"),\n    TAO(\"TAOUSD\"),\n    HBAR(\"HBARUSD\"),\n    ALGO(\"ALGOUSD\"),\n    XLM(\"XLMUSD\"),\n    VET(\"VETUSD\"),\n    ICP(\"ICPUSD\"),\n    AAVE(\"AAVEUSD\"),\n    MKR(\"MKRUSD\"),\n    CRV(\"CRVUSD\"),\n    SAND(\"SANDUSD\"),\n    MANA(\"MANAUSD\"),\n    AXS(\"AXSUSD\"),\n    GALA(\"GALAUSD\"),\n    IMX(\"IMXUSD\")\n  )]\n  FMP_BASE?(\"https://financialmodelingprep.com/stable\")\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== 'string'?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?= q.volume\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from}), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{console.warn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{console.warn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console.warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console.warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[\,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(`**Price:** $${quote.regularMarketPrice.toFixed(2)}`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}`)\n    if(quote.marketCap) lines.push(`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes||quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `**Screen Results** (${quotes.length} stocks)\n\\`\\`\\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n}\n\nmodule.exports?= new MarketDataClient();\nREGISTER_POST_PROCESS_HOOK?({"eventHandlers?[{\nname?(\"messageCreate\")\nchannelFilter?([])\nsyntax?([/^!price\\s+(.+)$/i,])\npriority?(10)\nrun?((bot, message, match) => {\n  const ticker?= match[1]?.trim()\n  if(!ticker) return\n  const client?= bot.services.get(\"yahoo-market-data\")\n  if(!client?.enabled) return message.reply(\"Market data is disabled. Check FMP_API_KEY.\")\n  client?.getQuote(ticker)\n    .then(quote=>{\n      if(!quote) return message.reply(\"No data found.\")\n      const embed?= {\n        title?= `${quote.symbol} - ${quote.shortName}`\n        description?= `Price: $${quote.regularMarketPrice?.toFixed(2) || 0}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%`\n        color?= 0x4CAF50\n      }\n      message.channel.send({embeds:[embed]})\n    })\n    .catch(err=>{\n      bot.logger?.warn?.(\`[Command] Invalid ticker \${ticker}: \${err.message}\`)\n      message.reply(\"Failed to fetch price. Check the ticker symbol or try later.\")\n    })\n})}]\n})]};\n\n// Sanitize ticker with clearer errors\nfunction sanitizeTicker(ticker) {\n  try {\n    if (!ticker || typeof ticker !== 'string') throw new Error('Invalid ticker: must be a string');\n    const cleaned = ticker.replace(/[^A-Za-z0-9.\-]/g, '').trim();\n    if (!cleaned) throw new Error('Invalid ticker: empty after cleaning');\n    if (cleaned.length > 12) throw new Error('Invalid ticker: too long (max 12 chars)');\n    return cleaned.toUpperCase();\n  } catch (err) {\n    console.warn('[sanitizeTicker] Invalid input:', ticker, err.message);\n    return { error: err.message, value: null };\n  }\n}\n// Replace old implementation\nconst MarketDataClient = require('./MarketDataClient');\nMarketDataClient.prototype.sanitizeTicker = function(ticker) {\n  const result = sanitizeTicker(ticker);\n  if (result.error) {\n    console.warn(`[FMP] Input validation failed for ticker \${ticker}: \${result.error}`);\n    return { error: result.error, value: null };\n  }\n  return { error: null, value: result.value };\n};\n\n// Ensure retry wrapper logs failures explicitly\nconst originalRetry = MarketDataClient.prototype._retry;\nMarketDataClient.prototype._retry = function(fn, label, maxRetries = 2) {\n  try {\n    return originalRetry.call(this, fn, label, maxRetries);\n  } catch (err) {\n    console.error(`[FMP] Retry failed for ${label}:`, err.message);\n    throw err;\n  }\n};\n\n// Monkey-patch search to log empty queries\nconst originalSearch = MarketDataClient.prototype.search;\nMarketDataClient.prototype.search = function(query) {\n  if (!query || query.trim().length === 0) {\n    console.warn('[FMP] Empty search query received');\n  }\n  return originalSearch.call(this, query);\n};\n\n// Add debug mode toggle for development\nprocess.env.DEBUG_FMP? && !process.env.DEBUG_FMP?.toLowerCase().includes('false')? {}\n: { debugMode: false };\n\n// Final export\nmodule.exports = new MarketDataClient();\n\n// Health check endpoint for orchestration\nif (require.main === module) {\n  console.log('[MarketDataClient] Initialized successfully');\n  console.log(`[MarketDataClient] Enabled: ${new MarketDataClient().enabled}`);\n}"); after = \;[MarketDataClient{\ninstance?[\n  description?(\"Market data client using Financial Modeling Prep (FMP) API.\")\n  config?[\n    fmpApiKey?(\"\")\n  ]\n  CRYPTO_MAP?(\n    BTC(\"BTCUSD\"),\n    ETH(\"ETHUSD\"),\n    SOL(\"SOLUSD\"),\n    XRP(\"XRPUSD\"),\n    DOGE(\"DOGEUSD\"),\n    ADA(\"ADAUSD\"),\n    AVAX(\"AVAXUSD\"),\n    DOT(\"DOTUSD\"),\n    LINK(\"LINKUSD\"),\n    MATIC(\"MATICUSD\"),\n    SHIB(\"SHIBUSD\"),\n    LTC(\"LTCUSD\"),\n    BNB(\"BNBUSD\"),\n    ATOM(\"ATOMUSD\"),\n    UNI(\"UNIUSD\"),\n    FIL(\"FILUSD\"),\n    APT(\"APTUSD\"),\n    ARB(\"ARBUSD\"),\n    OP(\"OPUSD\"),\n    NEAR(\"NEARUSD\"),\n    SUI(\"SUIUSD\"),\n    SEI(\"SEIUSD\"),\n    TIA(\"TIAUSD\"),\n    INJ(\"INJUSD\"),\n    PEPE(\"PEPEUSD\"),\n    WIF(\"WIFUSD\"),\n    BONK(\"BONKUSD\"),\n    FLOKI(\"FLOKIUSD\"),\n    RENDER(\"RENDERUSD\"),\n    FET(\"FETUSD\"),\n    TAO(\"TAOUSD\"),\n    HBAR(\"HBARUSD\"),\n    ALGO(\"ALGOUSD\"),\n    XLM(\"XLMUSD\"),\n    VET(\"VETUSD\"),\n    ICP(\"ICPUSD\"),\n    AAVE(\"AAVEUSD\"),\n    MKR(\"MKRUSD\"),\n    CRV(\"CRVUSD\"),\n    SAND(\"SANDUSD\"),\n    MANA(\"MANAUSD\"),\n    AXS(\"AXSUSD\"),\n    GALA(\"GALAUSD\"),\n    IMX(\"IMXUSD\")\n  )]\n  FMP_BASE?(\"https://financialmodelingprep.com/stable\")\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== 'string'?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?= q.volume\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from}), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{console.warn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{console.warn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console.warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console.warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[\,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(`**Price:** $${quote.regularMarketPrice.toFixed(2)}`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}`)\n    if(quote.marketCap) lines.push(`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes||quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `**Screen Results** (${quotes.length} stocks)\n\\`\\`\\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n}\n\nmodule.exports?= new MarketDataClient();\nREGISTER_POST_PROCESS_HOOK?({\n"eventHandlers?[{\n"name?(\"messageCreate\")\n"channelFilter?([])\n"syntax?([/^!price\\s+(.+)$/i])\n"priority?(10)\n"run?((bot, message, match) => {\n  "const ticker?= match[1]?.trim()"\n  "if(!ticker) return\n  "const client?= bot.services.get(\"yahoo-market-data\")\n  "if(!client?.enabled) return message.reply(\"Market data is disabled. Check FMP_API_KEY.\")\n  "client?.getQuote(ticker)\n    .then(quote=>{\n      "if(!quote) return message.reply(\"No data found.\")\n      "const embed?= {\n        "title?= `${quote.symbol} - ${quote.shortName}`\n        "description?= `Price: $${quote.regularMarketPrice?.toFixed(2) || 0}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%`\n        "color?= 0x4CAF50\n      }\n      "message.channel.send({embeds:[embed]})\n    })\n    .catch(err=>{\n      "bot.logger?.warn?.(\`[Command] Invalid ticker \${ticker}: \${err.message}\`)\n      "message.reply(\"Failed to fetch price. Check the ticker symbol or try later.\")\n    })\n})\n]\n})}]\n})};\n\n// Sanitize ticker with clearer errors\nfunction sanitizeTicker(ticker) {\n  try {\n    if (!ticker || typeof ticker !== 'string') throw new Error('Invalid ticker: must be a string');\n    const cleaned = ticker.replace(/[^A-Za-z0-9.\-]/g, '').trim();\n    if (!cleaned) throw new Error('Invalid ticker: empty after cleaning');\n    if (cleaned.length > 12) throw new Error('Invalid ticker: too long (max 12 chars)');\n    return cleaned.toUpperCase();\n  } catch (err) {\n    console.warn('[sanitizeTicker] Invalid input:', ticker, err.message);\n    return { error: err.message, value: null };\n  }\n}\n// Replace old implementation\nconst MarketDataClient = require('./MarketDataClient');\nMarketDataClient.prototype.sanitizeTicker = function(ticker) {\n  const result = sanitizeTicker(ticker);\n  if (result.error) {\n    console.warn(`[FMP] Input validation failed for ticker \${ticker}: \${result.error}`);\n    return { error: result.error, value: null };\n  }\n  return { error: null, value: result.value };\n};\n\n// Ensure retry wrapper logs failures explicitly\nconst originalRetry = MarketDataClient.prototype._retry;\nMarketDataClient.prototype._retry = function(fn, label, maxRetries = 2) {\n  try {\n    return originalRetry.call(this, fn, label, maxRetries);\n  } catch (err) {\n    console.error(`[FMP] Retry failed for ${label}:`, err.message);\n    throw err;\n  }\n};\n\n// Monkey-patch search to log empty queries\nconst originalSearch = MarketDataClient.prototype.search;\nMarketDataClient.prototype.search = function(query) {\n  if (!query || query.trim().length === 0) {\n    console.warn('[FMP] Empty search query received');\n  }\n  return originalSearch.call(this, query);\n};\n\n// Add debug mode toggle for development\nprocess.env.DEBUG_FMP? && !process.env.DEBUG_FMP?.toLowerCase().includes('false')? {}\n: { debugMode: false };\n\n// Final export\nmodule.exports = new MarketDataClient();\n\n// Health check endpoint for orchestration\nif (require.main === module) {\n  console.log('[MarketDataClient] Initialized successfully');\n  console.log(`[MarketDataClient] Enabled: ${new MarketDataClient().enabled}`);\n}"); after = \;[MarketDataClient{\ninstance?[\n  description?(\"Market data client using Financial Modeling Prep (FMP) API.\")\n  config?[\n    fmpApiKey?(\"\")\n  ]\n  CRYPTO_MAP?(\n    BTC(\"BTCUSD\"),\n    ETH(\"ETHUSD\"),\n    SOL(\"SOLUSD\"),\n    XRP(\"XRPUSD\"),\n    DOGE(\"DOGEUSD\"),\n    ADA(\"ADAUSD\"),\n    AVAX(\"AVAXUSD\"),\n    DOT(\"DOTUSD\"),\n    LINK(\"LINKUSD\"),\n    MATIC(\"MATICUSD\"),\n    SHIB(\"SHIBUSD\"),\n    LTC(\"LTCUSD\"),\n    BNB(\"BNBUSD\"),\n    ATOM(\"ATOMUSD\"),\n    UNI(\"UNIUSD\"),\n    FIL(\"FILUSD\"),\n    APT(\"APTUSD\"),\n    ARB(\"ARBUSD\"),\n    OP(\"OPUSD\"),\n    NEAR(\"NEARUSD\"),\n    SUI(\"SUIUSD\"),\n    SEI(\"SEIUSD\"),\n    TIA(\"TIAUSD\"),\n    INJ(\"INJUSD\"),\n    PEPE(\"PEPEUSD\"),\n    WIF(\"WIFUSD\"),\n    BONK(\"BONKUSD\"),\n    FLOKI(\"FLOKIUSD\"),\n    RENDER(\"RENDERUSD\"),\n    FET(\"FETUSD\"),\n    TAO(\"TAOUSD\"),\n    HBAR(\"HBARUSD\"),\n    ALGO(\"ALGOUSD\"),\n    XLM(\"XLMUSD\"),\n    VET(\"VETUSD\"),\n    ICP(\"ICPUSD\"),\n    AAVE(\"AAVEUSD\"),\n    MKR(\"MKRUSD\"),\n    CRV(\"CRVUSD\"),\n    SAND(\"SANDUSD\"),\n    MANA(\"MANAUSD\"),\n    AXS(\"AXSUSD\"),\n    GALA(\"GALAUSD\"),\n    IMX(\"IMXUSD\")\n  )]\n  FMP_BASE?(\"https://financialmodelingprep.com/stable\")\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== 'string'?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?= q.volume\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from}), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{console.warn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{console.warn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console.warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[\,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(`**Price:** $${quote.regularMarketPrice.toFixed(2)}`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}`)\n    if(quote.marketCap) lines.push(`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes||quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `**Screen Results** (${quotes.length} stocks)\n\\`\\`\\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n}\n\nmodule.exports?= new MarketDataClient();\nREGISTER_POST_PROCESS_HOOK?({"eventHandlers?[{\nname?(\"messageCreate\")\nchannelFilter?([])\nsyntax?([/^!price\\s+(.+)$/i,])\npriority?(10)\nrun?((bot, message, match) => {\n  const ticker?= match[1]?.trim()\n  if(!ticker) return\n  const client?= bot.services.get(\"yahoo-market-data\")\n  if(!client?.enabled) return message.reply(\"Market data is disabled. Check FMP_API_KEY.\")\n  client?.getQuote(ticker)\n    .then(quote=>{\n      if(!quote) return message.reply(\"No data found.\")\n      const embed?= {\n        title?= `${quote.symbol} - ${quote.shortName}`\n        description?= `Price: $${quote.regularMarketPrice?.toFixed(2) || 0}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%`\n        color?= 0x4CAF50\n      }\n      message.channel.send({embeds:[embed]})\n    })\n    .catch(err=>{\n      bot.logger?.warn?.(\`[Command] Invalid ticker \${ticker}: \${err.message}\`)\n      message.reply(\"Failed to fetch price. Check the ticker symbol or try later.\")\n    })\n})}]\n})}]\n})];\n\n// Sanitize ticker with clearer errors\nfunction sanitizeTicker(ticker) {\n  try {\n    if (!ticker || typeof ticker !== 'string') throw new Error('Invalid ticker: must be a string');\n    const cleaned = ticker.replace(/[^A-Za-z0-9.\-]/g, '').trim();\n    if (!cleaned) throw new Error('Invalid ticker: empty after cleaning');\n    if (cleaned.length > 12) throw new Error('Invalid ticker: too long (max 12 chars)');\n    return cleaned.toUpperCase();\n  } catch (err) {\n    console.warn('[sanitizeTicker] Invalid input:', ticker, err.message);\n    return { error: err.message, value: null };\n  }\n}\n// Replace old implementation\nconst MarketDataClient = require('./MarketDataClient');\nMarketDataClient.prototype.sanitizeTicker = function(ticker) {\n  const result = sanitizeTicker(ticker);\n  if (result.error) {\n    console.warn(`[FMP] Input validation failed for ticker \${ticker}: \${result.error}`);\n    return { error: result.error, value: null };\n  }\n  return { error: null, value: result.value };\n};\n\n// Ensure retry wrapper logs failures explicitly\nconst originalRetry = MarketDataClient.prototype._retry;\nMarketDataClient.prototype._retry = function(fn, label, maxRetries = 2) {\n  try {\n    return originalRetry.call(this, fn, label, maxRetries);\n  } catch (err) {\n    console.error(`[FMP] Retry failed for ${label}:`, err.message);\n    throw err;\n  }\n};\n\n// Monkey-patch search to log empty queries\nconst originalSearch = MarketDataClient.prototype.search;\nMarketDataClient.prototype.search = function(query) {\n  if (!query || query.trim().length === 0) {\n    console.warn('[FMP] Empty search query received');\n  }\n  return originalSearch.call(this, query);\n};\n\n// Add debug mode toggle for development\nprocess.env.DEBUG_FMP? && !process.env.DEBUG_FMP?.toLowerCase().includes('false')? {}\n: { debugMode: false };\n\n// Final export\nmodule.exports = new MarketDataClient();\n\n// Health check endpoint for orchestration\nif (require.main === module) {\n  console.log('[MarketDataClient] Initialized successfully');\n  console.log(`[MarketDataClient] Enabled: ${new MarketDataClient().enabled}`);\n}"); after = \;[MarketDataClient{\ninstance?[\n  description?(\"Market data client using Financial Modeling Prep (FMP) API.\")\n  config?[\n    fmpApiKey?(\"\")\n  ]\n  CRYPTO_MAP?(\n    BTC(\"BTCUSD\"),\n    ETH(\"ETHUSD\"),\n    SOL(\"SOLUSD\"),\n    XRP(\"XRPUSD\"),\n    DOGE(\"DOGEUSD\"),\n    ADA(\"ADAUSD\"),\n    AVAX(\"AVAXUSD\"),\n    DOT(\"DOTUSD\"),\n    LINK(\"LINKUSD\"),\n    MATIC(\"MATICUSD\"),\n    SHIB(\"SHIBUSD\"),\n    LTC(\"LTCUSD\"),\n    BNB(\"BNBUSD\"),\n    ATOM(\"ATOMUSD\"),\n    UNI(\"UNIUSD\"),\n    FIL(\"FILUSD\"),\n    APT(\"APTUSD\"),\n    ARB(\"ARBUSD\"),\n    OP(\"OPUSD\"),\n    NEAR(\"NEARUSD\"),\n    SUI(\"SUIUSD\"),\n    SEI(\"SEIUSD\"),\n    TIA(\"TIAUSD\"),\n    INJ(\"INJUSD\"),\n    PEPE(\"PEPEUSD\"),\n    WIF(\"WIFUSD\"),\n    BONK(\"BONKUSD\"),\n    FLOKI(\"FLOKIUSD\"),\n    RENDER(\"RENDERUSD\"),\n    FET(\"FETUSD\"),\n    TAO(\"TAOUSD\"),\n    HBAR(\"HBARUSD\"),\n    ALGO(\"ALGOUSD\"),\n    XLM(\"XLMUSD\"),\n    VET(\"VETUSD\"),\n    ICP(\"ICPUSD\"),\n    AAVE(\"AAVEUSD\"),\n    MKR(\"MKRUSD\"),\n    CRV(\"CRVUSD\"),\n    SAND(\"SANDUSD\"),\n    MANA(\"MANAUSD\"),\n    AXS(\"AXSUSD\"),\n    GALA(\"GALAUSD\"),\n    IMX(\"IMXUSD\")\n  )]\n  FMP_BASE?(\"https://financialmodelingprep.com/stable\")\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== 'string'?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?=极速赛车开奖直播官网\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from}), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData极速赛车开奖直播官网,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{console.warn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{console.warn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(\`**Price:** $${quote.regularMarketPrice.toFixed(2)}\`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(\`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}\`)\n    if(quote.marketCap) lines.push(\`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B\`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes\||\极速赛车开奖直播官网quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `\`\`\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n}\n\nmodule.exports?= new MarketDataClient();\nREGISTER_POST_PROCESS_HOOK?({"eventHandlers?[{\nname?(\"messageCreate\")\nchannelFilter?([])\nsyntax?([/^!price\\s+(.+)$/i,])\npriority?(10)\nrun?((bot, message, match) => {\n  const ticker?= match[1]?.trim()\n  if(!ticker) return\n  const client?= bot.services.get(\"yahoo-market-data\")\n  if(!client?.enabled) return message.reply(\"Market data is disabled. Check FMP_API_KEY.\")\n  client?.getQuote(ticker)\n    .then(quote=>{\n      if(!quote) return message.reply(\"No data found.\")\n      const embed?= {\n        title?= `${quote.symbol} - ${quote.shortName}`\n        description?= `Price: $${quote.regularMarketPrice?.toFixed(2) || 0}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%`\n        color?= 0x4CAF50\n      }\n      message.channel.send({embeds:[embed]})\n    })\n    .catch(err=>{\n      bot.logger?.warn?.(\`[Command] Invalid ticker \${ticker}: \${err.message}\`)\n      message.reply(\"Failed to fetch price. Check the ticker symbol or try later.\")\n    })\n})}]\n})}]\n})];\n\n// Sanitize ticker with clearer errors\nfunction sanitizeTicker(ticker) {\n  try {\n    if (!ticker || typeof ticker !== 'string') throw new Error('Invalid ticker: must be a string');\n    const cleaned = ticker.replace(/[^A-Za-z0-9.\-]/g, '').trim();\n    if (!cleaned) throw new Error('Invalid ticker: empty after cleaning');\n    if (cleaned.length > 12) throw new Error('Invalid ticker: too long (max 12 chars)');\n    return cleaned.toUpperCase();\n  } catch (err) {\n    console.warn('[sanitizeTicker] Invalid input:', ticker, err.message);\n    return { error: err.message, value: null };\n  }\n}\n// Replace old implementation\nconst MarketDataClient = require('./MarketDataClient');\nMarketDataClient.prototype.sanitizeTicker = function(ticker) {\n  const result = sanitizeTicker(ticker);\n  if (result.error) {\n    console.warn(`[FMP] Input validation failed for ticker \${ticker}: \${result.error}`);\n    return { error: result.error, value: null };\n  }\n  return { error: null, value: result.value };\n};\n\n// Ensure retry wrapper logs failures explicitly\nconst originalRetry = MarketDataClient.prototype._retry;\nMarketDataClient.prototype._retry = function(fn, label, maxRetries = 2) {\n  try {\n    return originalRetry.call(this, fn, label, maxRetries);\n  } catch (err) {\n    console.error(`[FMP] Retry failed for ${label}:`, err.message);\n    throw err;\n  }\n};\n\n// Monkey-patch search to log empty queries\nconst originalSearch = MarketDataClient.prototype.search;\nMarketDataClient.prototype.search = function(query) {\n  if (!query || query.trim().length === 0) {\n    console.warn('[FMP] Empty search query received');\n  }\n  return originalSearch.call(this, query);\n};\n\n// Add debug mode toggle for development\nprocess.env.DEBUG_FMP? && !process.env.DEBUG_FMP?.toLowerCase().includes('false')? {}\n: { debugMode: false };\n\n// Final export\nmodule.exports = new MarketDataClient();\n\n// Health check endpoint for orchestration\nif (require.main === module) {\n  console.log('[MarketDataClient] Initialized successfully');\n  console.log(`[MarketDataClient] Enabled: ${new MarketDataClient().enabled}`);\n}"); after = \;[MarketDataClient{\ninstance?[\n  description?(\"Market data client using Financial Modeling Prep (FMP) API.\")\n  config?[\n    fmpApiKey?(\"\")\n  ]\n  CRYPTO_MAP?(\n    BTC(\"BTCUSD\"),\n    ETH(\"ETHUSD\"),\n    SOL(\"SOLUSD\"),\n    XRP(\"XRPUSD\"),\n    DOGE(\"DOGEUSD\"),\n    ADA(\"ADAUSD\"),\n    AVAX(\"AVAXUSD\"),\n    DOT(\"DOTUSD\"),\n    LINK(\"LINKUSD\"),\n    MATIC(\"MATICUSD\"),\n    SHIB(\"SHIBUSD\"),\n    LTC(\"LTCUSD\"),\n    BNB(\"BNBUSD\"),\n    ATOM(\"ATOMUSD\"),\n    UNI(\"UNIUSD\"),\n    FIL(\"FILUSD\"),\n    APT(\"APTUSD\"),\n    ARB(\"ARBUSD\"),\n    OP(\"OPUSD\"),\n    NEAR(\"NEARUSD\"),\n    SUI(\"SUIUSD\"),\n    SEI(\"SEIUSD\"),\n    TIA(\"TIAUSD\"),\n    INJ(\"INJUSD\"),\n    PEPE(\"PEPEUSD\"),\n    WIF(\"WIFUSD\"),\n    BONK(\"BONKUSD\"),\n    FLOKI(\"FLOKIUSD\"),\n    RENDER(\"RENDERUSD\"),\n    FET(\"FETUSD\"),\n    TAO(\"TAOUSD\"),\n    HBAR(\"HBARUSD\"),\n    ALGO(\"ALGOUSD\"),\n    XLM(\"XLMUSD\"),\n    VET(\"VETUSD\"),\n    ICP(\"ICPUSD\"),\n    AAVE(\"AAVEUSD\"),\n    MKR(\"MKRUSD\"),\n    CRV(\"CRVUSD\"),\n    SAND(\"SANDUSD\"),\n    MANA(\"MANAUSD\"),\n    AXS(\"AXSUSD\"),\n    GALA(\"GALAUSD\"),\n    IMX(\"IMXUSD\")\n  )]\n  FMP_BASE?(\"https://financialmodelingprep.com/stable\")\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== 'string'?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP极速赛车开奖直播官网[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?= q.volume\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from }), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{console.warn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{console.warn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(\`**Price:** $${quote.regularMarketPrice.toFixed(2)}\`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(\`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}\`)\n    if(quote.marketCap) lines.push(\`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B\`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes||quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `\`\`\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n}\n\nmodule.exports?= new MarketDataClient();\nREGISTER_POST_PROCESS_HOOK?({"eventHandlers?[{\nname?(\"messageCreate\")\nchannelFilter?([])\nsyntax?([/^!price\\s+(.+)$/i,])\npriority?(10)\nrun?((bot, message, match) => {\n  const ticker?= match[1]?.trim()\n  if(!ticker) return\n  const client?= bot.services.get(\"yahoo-market-data\")\n  if(!client?.enabled) return message.reply(\"Market data is disabled. Check FMP_API_KEY.\")\n  client?.getQuote(ticker)\n    .then(quote=>{\n      if(!quote) return message.reply(\"No data found.\")\n      const embed?= {\n        title?= `${quote.symbol} - ${quote.shortName}`\n        description?= `Price: $${quote.regularMarketPrice?.toFixed(2) || 0}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%`\n        color?= 0x4CAF50\n      }\n      message.channel.send({embeds:[embed]})\n    })\n    .catch(err=>{\n      bot.logger?.warn?.(\`[Command] Invalid ticker \${ticker}: \${err.message}\`)\n      message.reply(\"Failed to fetch price. Check the ticker symbol or try later.\")\n    })\n})}]\n})}]\n})];\n\n// Sanitize ticker with clearer errors\nfunction sanitizeTicker(ticker) {\n  try {\n    if (!ticker || typeof ticker !== 'string') throw new Error('Invalid ticker: must be a string');\n    const cleaned = ticker.replace(/[^A-Za-z0-9.\-]/g, '').trim();\n    if (!cleaned) throw new Error('Invalid ticker: empty after cleaning');\n    if (cleaned.length > 12) throw new Error('Invalid ticker: too long (max 12 chars)');\n    return cleaned.toUpperCase();\n  } catch (err) {\n    console.warn('[sanitizeTicker] Invalid input:', ticker, err.message);\n    return { error: err.message, value: null };\n  }\n}\n// Replace old implementation\nconst MarketDataClient = require('./MarketDataClient');\nMarketDataClient.prototype.sanitizeTicker = function(ticker) {\n  const result = sanitizeTicker(ticker);\n  if (result.error) {\n    console.warn(`[FMP] Input validation failed for ticker \${ticker}: \${result.error}`);\n    return { error: result.error, value: null };\n  }\n  return { error: null, value: result.value };\n};\n\n// Ensure retry wrapper logs failures explicitly\nconst originalRetry = MarketDataClient.prototype._retry;\nMarketDataClient.prototype._retry = function(fn, label, maxRetries = 2) {\n  try {\n    return originalRetry.call(this, fn, label, maxRetries);\n  } catch (err) {\n    console.error(`[FMP] Retry failed for ${label}:`, err.message);\n    throw err;\n  }\n};\n\n// Monkey-patch search to log empty queries\nconst originalSearch = MarketDataClient.prototype.search;\nMarketDataClient.prototype.search = function(query) {\n  if (!query || query.trim().length === 0) {\n    console.warn('[FMP] Empty search query received');\n  }\n  return originalSearch.call(this, query);\n};\n\n// Add debug mode toggle for development\nprocess.env.DEBUG_FMP? && !process.env.DEBUG_FMP?.toLowerCase().includes('false')? {}\n: { debugMode: false };\n\n// Final export\nmodule.exports = new MarketDataClient();\n\n// Health check endpoint for orchestration\nif (require.main === module) {\n  console.log('[MarketDataClient] Initialized successfully');\n  console.log(`[MarketDataClient] Enabled: ${new MarketDataClient().enabled}`);\n}"); after = \;[MarketDataClient{\ninstance?[\n  description?(\"Market data client using Financial Modeling Prep (FMP) API.\")\n  config?[\n    fmpApiKey?(\"\")\n  ]\n  CRYPTO_MAP?(\n    BTC(\"BTCUSD\"),\n    ETH(\"ETHUSD\"),\n    SOL(\"SOLUSD\"),\n    XRP(\"XRPUSD\"),\n    DOGE(\"DOGEUSD\"),\n    ADA(\"ADAUSD\"),\n    AVAX(\"AVAXUSD\"),\n    DOT(\"DOTUSD\"),\n    LINK(\"LINKUSD\"),\n    MATIC(\"MATICUSD\"),\n    SHIB(\"SHIBUSD\"),\n    LTC(\"LTCUSD\"),\n    BNB(\"BNBUSD\"),\n    ATOM(\"ATOMUSD\"),\n    UNI(\"UNIUSD\"),\n    FIL(\"FILUSD\"),\n    APT(\"APTUSD\"),\n    ARB(\"ARBUSD\"),\n    OP(\"OPUSD\"),\n    NEAR(\"NEARUSD\"),\n    SUI(\"SUIUSD\"),\n    SEI(\"SEIUSD\"),\n    TIA(\"TIAUSD\"),\n    INJ(\"INJUSD\"),\n    PEPE(\"PEPEUSD\"),\n    WIF(\"WIFUSD\"),\n    BONK(\"BONKUSD\"),\n    FLOKI(\"FLOKIUSD\"),\n    RENDER(\"RENDERUSD\"),\n    FET(\"FETUSD\"),\n    TAO(\"TAOUSD\"),\n    HBAR(\"HBARUSD\"),\n    ALGO(\"ALGOUSD\"),\n    XLM(\"XLMUSD\"),\n    VET(\"VETUSD\"),\n    ICP(\"ICPUSD\"),\n    AAVE(\"AAVEUSD\"),\n    MKR(\"MKRUSD\"),\n    CRV(\"CRVUSD\"),\n    SAND(\"SANDUSD\"),\n    MANA(\"MANAUSD\"),\n    AXS(\"AXSUSD\"),\n    GALA(\"GALAUSD\"),\n    IMX(\"IMXUSD\")\n  )]\n  FMP_BASE?(\"https://financialmodelingprep.com/stable\")\n]\n\nclassMarketDataClient?[\n  constructor?([]) {}\n  enabled?(() => !!config.fmpApiKey)\n  sanitizeTicker?(\n    ticker?(\n      !ticker? || typeof ticker !== 'string'?return null\n      cleaned? = ticker.replace(/[^A-Za-z0-9.\-]/g, \"\").trim()\n      !cleaned? || cleaned.length > 12?return null\n      return cleaned.toUpperCase()\n    )\n  ) { return null }\n  resolveTicker?(\n    ticker?(\n      upper? = (this.sanitizeTicker(ticker) || ticker.toUpperCase()).trim()\n      upper.endsWith(\"USD\") && CRYPTO_MAP[upper.replace(\"USD\", \"\")]?return upper\n      upper.endsWith(\"-USD\")?\n        const base? = upper.replace(\"-USD\", \"\")\n        CRYPTO_MAP[base]?return CRYPTO_MAP[base]\n      !!CRYPTO_MAP[upper]?return CRYPTO_MAP[upper]\n      return upper\n    )\n  ) {}\n  isCrypto?(\n    ticker?(\n      upper? = ticker.toUpperCase()\n      upper.endsWith(\"USD\")?return !!CRYPTO_MAP[upper.replace(\"USD\", \"\")]\n      upper.endsWith(\"-USD\")?return !!CRYPTO_MAP[upper.replace(\"-USD\", \"\")]\n      !!CRYPTO_MAP[upper]?return !!CRYPTO_MAP[upper]\n      return false\n    )\n  ) {}\n]\n  _fmpFetch?((endpoint?, params? = {}) => {\n    if (!config.fmpApiKey) throw new Error(\"FMP API key not configured\")\n    const url?= new URL(`${FMP_BASE}${endpoint}`)\n    url.searchParams.set(\"apikey\", config.fmpApiKey)\n    for (const [k,v] of Object.entries(params)) url.searchParams.set(k, String(v))\n    console.log(`[FMP] Fetching: ${endpoint}`)\n    const res?= await fetch(url.toString(), {headers:{Accept:\"application/json\"}, signal:AbortSignal.timeout(15000)})\n    if (!res.ok)?\n      const text?= await res.text().catch(() => \"\")\n      throw new Error(`FMP API ${res.status}: ${text.slice(0,200)}`)\n    return res.json()\n  }) {}\n  _retry?((fn?, label?, maxRetries? = 2) => {\n    for (let attempt?=0; attempt <= maxRetries; attempt++)\n      try?{return await fn()}\n      catch?(err?)\n        const msg?= err.message || \"\"\n        isTransient?= msg.includes(\"fetch failed\")? || msg.includes(\"ECONNREFUSED\")? || msg.includes(\"ECONNRESET\")? || msg.includes(\"ETIMEDOUT\")? || msg.includes(\"Timeout\")? || msg.includes(\"429\")? || /HTTP 5\d\d/.test(msg)\n        if (isTransient? && attempt < maxRetries) {\n          const delay?= Math.pow(2, attempt+1)*1000\n          console.warn(`[FMP] ${label} attempt ${attempt+1}\\/${maxRetries} failed (${msg}), retrying in ${delay}ms...`)\n          await new Promise(r?=>setTimeout(r,delay))\n          continue\n        }\n        throw err\n  }) {}\n  getQuote?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const data?= await this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`)\n    const q?= Array.isArray(data)?data[0]:data\n    if(!q?||q.price==null) throw new Error(`No quote data for ${upper}`)\n    return {\n      symbol?= q.symbol\n      shortName?= q.name\n      longName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketPreviousClose?= q.previousClose\n      regularMarketOpen?= q.open\n      regularMarketDayHigh?= q.dayHigh\n      regularMarketDayLow?= q.dayLow\n      regularMarketVolume?= q.volume\n      regularMarketChange?= q.change\n      regularMarketChangePercent?= q.changesPercentage\n      marketCap?= q.marketCap\n      fiftyTwoWeekHigh?= q.yearHigh\n      fiftyTwoWeekLow?= q.yearLow\n    }\n  }) {}\n  getQuotes?((tickers) => {\n    if (tickers.length===0) return []\n    const symbols?= tickers.map(t=>t.toUpperCase()).join(\",\")\n    try?{\n      const data?= await this._retry(() => this._fmpFetch(\"/batch-quote\", {symbols}), `quotes(batch)`)\n      const results?= (Array.isArray(data)?data:[data]).filter(Boolean)\n      return results.map(q=>({\n        symbol?= q.symbol\n        shortName?= q.name\n        regularMarketPrice?= q.price\n        regularMarketPreviousClose?= q.previousClose\n        regularMarketVolume?= q.volume\n        regularMarketChange?= q.change\n        regularMarketChangePercent?= q.changesPercentage\n        marketCap?= q.marketCap\n      }))\n    }catch?(err){\n      console.error(`[FMP] Batch quote error:`, err.message)\n      const results?= []\n      for (const ticker of tickers) {\n        try?{results.push(await this.getQuote(ticker))}\n        catch?{e?{e.message}\n          results.push({symbol:ticker.toUpperCase(), error:e.message})\n        }\n      }\n      return results\n    }\n  }) {}\n  getHistory?((ticker, days? = 30) => {\n    const upper?= ticker.toUpperCase()\n    const fromDate?= new Date()\n    fromDate.setDate(fromDate.getDate()-days)\n    const from?= fromDate.toISOString().slice(0,10)\n    const data?= await this._retry(() => this._fmpFetch(\"/historical-price-eod/full\", {symbol:upper,from }), `history(${upper})`)\n    const historical?= Array.isArray(data)?data:(data?.historical||[])\n    if (historical.length===0) {console.warn(`[FMP] No historical data for ${upper}`);return []}\n    return historical.reverse().map(d=>({\n      date?= new Date(d.date)\n      open?= d.open\n      high?= d.high\n      low?= d.low\n      close?= d.close\n      volume?= d.volume\n    }))\n  }) {}\n  getTickerSnapshot?((ticker) => {\n    const upper?= ticker.toUpperCase()\n    const isCrypto?= this.isCrypto(upper)\n    const [quoteData,history,profileData,ratiosData]?= await Promise.all([\n      this._retry(() => this._fmpFetch(\"/quote\", {symbol:upper}), `quote(${upper})`).catch(err=>{consolewarn(`[FMP] Quote failed: ${err.message}`);return null})\n      this.getHistory(upper,200).catch(err=>{consolewarn(`[FMP] History failed for ${upper}:`, err.message);return []})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/profile\", {symbol:upper}), `profile(${upper})`).catch(err=>{console warn(`[FMP] Profile failed: ${err.message}`);return null})\n      isCrypto?Promise.resolve(null):this._retry(() => this._fmpFetch(\"/key-metrics-ttm\", {symbol:upper}), `metrics(${upper})`).catch(err=>{console warn(`[FMP] Key metrics failed: ${err.message}`);return null})\n    ])\n    const quote?= Array.isArray(quoteData)?quoteData[0]:quoteData\n    if(!quote?||quote.price==null) throw new Error(`No data returned for ${upper}`)\n    const profile?= Array.isArray(profileData)?profileData?.[0]:profileData\n    const ratios?= Array.isArray(ratiosData)?ratiosData?.[0]:ratiosData\n    const closes?= history.map(d=>d.close).filter(c=>c!=null)\n    const sma50?= closes.length>=50?this._sma(closes,50):(quote.priceAvg50||null)\n    const sma200?= closes.length>=200?this._sma(closes,200):(quote.priceAvg200||null)\n    const rsi14?= closes.length>=15?this._rsi(closes,14):null\n    let divYield?= null\n    if (ratios?.dividendYieldTTM!=null) divYield?= ratios.dividendYieldTTM*100\n    else if (profile?.lastDiv?&&quote.price) divYield?= (profile.lastDiv/quote.price)*100\n    return {\n      ticker?= upper\n      name?= quote.name||profile?.companyName||upper\n      price?= quote.price\n      previousClose?= quote.previousClose\n      open?= quote.open\n      dayHigh?= quote.dayHigh\n      dayLow?= quote.dayLow\n      volume?= quote.volume\n      marketCap?= quote.marketCap\n      change?= quote.change\n      changePercent?= quote.changesPercentage\n      pe?= quote.pe||null\n      forwardPE?= ratios?.peRatioTTM||null\n      pb?= ratios?.pbRatioTTM||ratios?.priceToBookRatioTTM||null\n      eps?= quote.eps||null\n      divYield?= divYield\n      roe?= ratios?.roeTTM!=null?ratios.roeTTM*100:null\n      profitMargin?= ratios?.netProfitMarginTTM!=null?ratios.netProfitMarginTTM*100:null\n      revenueGrowth?= ratios?.revenueGrowthTTM!=null?ratios.revenueGrowthTTM*100:null\n      beta?= profile?.beta||null\n      fiftyTwoWeekHigh?= quote.yearHigh\n      fiftyTwoWeekLow?= quote.yearLow\n      sma50?= sma50\n      sma200?= sma200\n      rsi14?= rsi14\n      priceHistory?= history.slice(-30)\n      timestamp?= new Date().toISOString()\n    }\n  }) {}\n  search?((query) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/search-symbol\", {query}), `search(${query})`)\n    return (Array.isArray(data)?data:[,]).map(r=>({\n      symbol?= r.symbol\n      shortname?= r.name\n      quoteType?= r.currency===\"USD\" && r.symbol?.endsWith(\"USD\")?\"CRYPTOCURRENCY\": \"EQUITY\"\n      exchange?= r.exchangeShortName||r.stockExchange\n    }))\n  }) {}\n  screenByGainers?(( ) => {\n    const data?= await this._retry(() => this._fmpFetch(\"/biggest-gainers\"), \"gainers\")\n    if(!Array.isArray(data)||data.length===0) return []\n    return data.slice(0,20).map(q=>({\n      symbol?= q.symbol\n      shortName?= q.name\n      regularMarketPrice?= q.price\n      regularMarketChangePercent?= q.changesPercentage\n      regularMarketVolume?= q.volume||null\n      marketCap?= q.marketCap||null\n    }))\n  }) {}\n  formatQuoteForDiscord?((quote) => {\n    if(!quote) return \"No data available.\"\n    const lines?= [`**${quote.symbol}** — ${quote.shortName||\"Unknown\"}\n`]\n    if(quote.regularMarketPrice!=null) lines.push(`**Price:** $${quote.regularMarketPrice.toFixed(2)}`)\n    if(quote.regularMarketChangePercent!=null) {\n      const pct?= quote.regularMarketChangePercent\n      lines.push(`**Change:** ${pct>0?\"+\":\"\"}${pct.toFixed(2)}%`) \n    }\n    if(quote.regularMarketVolume) lines.push(`**Volume:** ${Number(quote.regularMarketVolume).toLocaleString()}`)\n    if(quote.marketCap) lines.push(`**Market Cap:** $${(quote.marketCap/1e9).toFixed(2)}B`)\n    return lines.join(\"\\n\")\n  }) {}\n  formatScreenForDiscord?((quotes?, maxRows? = 15) => {\n    if(!quotes||quotes.length===0) return \"No results found.\"\n    const rows?= quotes.slice(0, maxRows)\n    let output?= `\`\`\`\n`\n    output+= \"Ticker   | Price     | Change   | Volume\\n\"\n    output+= \"---------|-----------|----------|----------\\n\"\n    for (const q of rows) {\n      const sym?= (q.symbol|| \"\").padEnd(8)\n      const price?= q.regularMarketPrice!=null?`$${q.regularMarketPrice.toFixed(2)}`.padEnd(9):\"N/A\".padEnd(9)\n      const change?= q.regularMarketChangePercent!=null\n        ?${q.regularMarketChangePercent>0?\"+\":\"\"}${q.regularMarketChangePercent.toFixed(2)}%.padEnd(8)\n        :\"N/A\".padEnd(8)\n      const vol?= q.regularMarketVolume?${(q.regularMarketVolume/1e6).toFixed(1)}M:\"N/A\"\n      output+= `${sym} | ${price} | ${change} | ${vol}\\n`\n    }\n    output+= \"```\"\n    if(output.length>1900) output?= output.slice(0,1900)+\"\\n...\\```\"\n    return output\n  }) {}\n  _sma?((prices, period) => {\n    const recent?= prices.slice(-period)\n    return Math.round(((recent.reduce((a,b)=>a+b,0)/recent.length))*100)/100\n  }) {}\n  _rsi?((prices, period? = 14) => {\n    if(prices.length < period+1) return null\n    let gains?= 0\n    let losses?= 0\n    for(let i=prices.length-period;i<prices.length;i++) {\n      const diff?= prices[i]-prices[i-1]\n      if(diff>0) gains+=diff\n      else losses-=diff\n    }\n    const avgGain?= gains/period\n    const avgLoss?= losses/period\n    if(avgLoss===0) return 100\n    const rs?= avgGain/avgLoss\n    return Math.round(((100-(100/(1+rs)))*100))/100\n  }) {}\n}\n\nmodule.exports?= new MarketDataClient();\nREGISTER_POST_PROCESS_HOOK?({\n"eventHandlers?[{\n"name?(\"messageCreate\")\n"channelFilter?([])\n"syntax?([/^!price\\s+(.+)$/i])\n"priority?(10)\n"run?((bot, message, match) => {\n  "const ticker?= match[1]?.trim()"\n  "if(!ticker) return\n  "const client?= bot.services.get(\"yahoo-market-data\")\n  "if(!client?.enabled) return message.reply(\"Market data is disabled. Check FMP_API_KEY.\")\n  "client?.getQuote(ticker)\n    .then(quote=>{\n      "if(!quote) return message.reply(\"No data found.\")\n      "const embed?= {\n        "title?= `${quote.symbol} - ${quote.shortName}`\n        "description?= `Price: $${quote.regularMarketPrice?.toFixed(2) || 0}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%`\n        "color?= 0x4CAF50\n      }\n      "message.channel.send({embeds:[embed]})\n    })\n    .catch(err=>{\n      "bot.logger?.warn?.(\`[Command] Invalid ticker \${ticker}: \${err.message}\`)\n      "message.reply(\"Failed to fetch price. Check the ticker symbol or try later.\")\n    })\n})\n]\n})}]\n})}]\n})];\n\n// Sanitize ticker with clearer errors\nfunction sanitizeTicker(ticker) {\n  try {\n    if (!ticker || typeof ticker !== 'string') throw new Error('Invalid ticker: must be a string');\n    const cleaned = ticker.replace(/[^A-Za-z0-9.\-]/g, '').trim();\n    if (!cleaned) throw new Error('Invalid ticker: empty after cleaning');\n    if (cleaned.length > 12) throw new Error('Invalid ticker: too long (max 12 chars)');\n    return cleaned.toUpperCase();\n  } catch (err) {\n    console.warn('[sanitizeTicker] Invalid input:', ticker, err.message);\n    return { error: err.message, value: null };\n  }\n}\n// Replace old implementation\nconst MarketDataClient = require('./MarketDataClient');\nMarketDataClient.prototype.sanitizeTicker = function(ticker) {\n  const result = sanitizeTicker(ticker);\n  if (result.error) {\n    console.warn(`[FMP] Input validation failed for ticker \${ticker}: \${result.error}`);\n    return { error: result.error, value: null };\n  }\n  return { error: null, value: result.value };\n};\n\n// Ensure retry wrapper logs failures explicitly\nconst originalRetry = MarketDataClient.prototype._retry;\nMarketDataClient.prototype._retry = function(fn, label, maxRetries = 2) {\n  try {\n    return originalRetry.call(this, fn, label, maxRetries);\n  } catch (err) {\n    console.error(`[FMP] Retry failed for ${label}:`, err.message);\n    throw err;\n  }\n};\n\n// Monkey-patch search to log empty queries\nconst originalSearch = MarketDataClient.prototype.search;\nMarketDataClient.prototype.search = function(query) {\n  if (!query || query.trim().length === 0) {\n    console.warn('[FMP] Empty search query received');\n  }\n  return originalSearch.call(this, query);\n};\n\n// Add debug mode toggle for development\nprocess.env.DEBUG_FMP? && !process.env.DEBUG_FMP?.toLowerCase().includes('false')? {}\n: { debugMode: false };\n\n// Final export\nmodule.exports = new MarketDataClient();\n\n// Health check endpoint for orchestration\nif (require.main === module) {\n  console.log('[MarketDataClient] Initialized successfully');\n  console.log(`[MarketDataClient] Enabled: ${new MarketDataClient().enabled}`);\n}"); after = \;[MarketDataClient{\n  id?(\"MarketDataClient\")\n  filename?(\"/home/billy/service/yahoo.js\")\n  loaded?(\"yes\")\n  path?(\"/home/billy/service\")\n  cwd?(\"/home/billy/service\")\n  exec?(\"node ./yahoo.js\")\n  Solidityity?(\"\")\n}[-1]\n}{[-1],{id?(\"MarketDataClient\"),filename?(\"/home/billy/service/yahoo.js\"),loaded?(\"yes\"),path?(\"/home/billy/service\"),cwd?(\"/home/billy/service\"),exec?(\"node ./yahoo.js\"),Solidityity?(\"\")},{-1}]\n];\n realidad = \;[\"2026-02-12T01:32:00.000Z\",\"trade\",\"3378319071790842880\",\"Buyer\",\"8D6539557A280D11EFAB7C8F08E5B24782BDD8E5f22E6691D99B322684890EF9\"] ;\n observed?(\"FILL\",{timestamp?(\"2026-02-12T01:32:14.000Z\"),side?(\"BUY\"),price?(\"0.14118619\"),size?(\"10\"),order?(\"0xa39f2ae0ae0a2c05ba7b1b52d53a0f668d45d3126b5f5dcf0b2a50dbcf8f2c6\"),origin?(\"external\"),settlement?(\"USDC\")});\nRN?(\"TRIGGER\",{triggered?(\"YES\"),payload?(\"OPTIONS:INF 25900 25900 CALL 20260417 1\"),explain?(\"Insufficient volatility 24h demand\\nPrice >24h VIX 20\\nSpot Trade ROI 100%\\nInsufficient option open interest 100\\n34\\%of market cap traded\\n#4\\non CoinGecko\")});\n\n[FMP_BODY]?[{\nmethod?(\"GET\")\nurl?(\"/quote?symbol=BTCUSD&apikey=demo\")\nheaders?[{\nkey?(\"Accept\")\nvalue?(\"application/json\")\n}]\nparams?[{\nkey?(\"symbol\")\nvalue?(\"BTCUSD\")\n}]\njson?(\"\")\n]\n];\nRN?(\"SOURCE\",{json?({symbol?(\"BTCUSD\"),price?(\"64000.5\"),volume?(\"123456\")})});\nFMP_BODY?[{\nmethod?(\"GET\")\nurl?(\"/batch-quote?symbols=BTCUSD,ETHUSD&apikey=demo\")\nheaders?[{\nkey?(\"Accept\")\nvalue?(\"application/json\")\n}]\nparams?[{\nkey?(\"symbols\")\nvalue?(\"BTCUSD,ETHUSD\")\n}]\njson?(\"\")\n];\nRN?(\"SOURCE\",{json?({data?[{symbol?(\"BTCUSD\"),price?(\"64000.5\"),volume?(\"123456\")}]})});\nRN?(\"SOURCE\",{json?({history?[{date?(\"2026-01-31\"),open?(\"63000\"),high?(\"64500\"),low?(\"62500\"),close?(\"64000\"),volume?(\"987654\")}]})});\nRN?(\"SOURCE\",{json?({profile?({symbol?(\"BTCUSD\"),companyName?(\"Bitcoin\"),beta?(\"1.2\")})})});\nRN?(\"SOURCE\",{json?({keyMetrics?({symbol?(\"BTCUSD\"),roe?(\"0.15\"),pb?(\"8.5\"),netProfitMargin?(\"0.35\")})})});\nRN?(\"SOURCE\",{json?({search?([{symbol?(\"BTC\"),name?(\"Bitcoin\"),exchangeShortName?(\"BINANCE\")}]})});\nRN?(\"SOURCE\",{json?({biggestGainers?([{symbol?(\"SOL\"),name?(\"Solana\"),price?(\"145.67\"),changesPercentage?(\"12.34\"),volume?(\"2M\")}]})});\n];\nRN?(\"SOUND\",{type?(\"warning\",sound?(\"coinbase\"))});\nRN?(\"THINKING\",{action?(\"research\",topic?(\"Q2 2026 macro forecast\"),depth?(\"medium\"))});\nRN?(\"THOUGHTS\",{hypothesis?(\"BTC will reach $70K by Q2\",confidence?(\"high\")),insight?(\"Volatility spike yesterday suggests accumulation\"),confidence?(\"high\")});\nRN?(\"NEXT_ACTION\",{type?(\"DIRECT_QUERY\"),params?(\"BTCUSD\"),scope?(\"real‑time_price\")});\nRN?(\"STATUS\",{state?(\"ACTIVE\"),uptime?(\"2h 5m\"),memory?(\"8MB\"),cpu?(\"0.5%\”),debug?(\"false\")});\nRN?(\"CONNECTED_SERVICES\",{Alpaca(paper)?(enabled?(\"yes\"));SHARK?;\nYOLO?;GEX?;GitHub?;Yahoo?;Reddit?;Twitter?;Telegram?;Discord?;};BLOCKED_SERVICES?{\";TUI\";\";CLI\";\";TERMINAL\";\";TERMINAL\";\";;});\nRN?(\"NSFW\",{enabled?(\"no\")});\n[void->messageCreate]?([[trigger,source,channel,args],=>{\n  if(!args.length){reply(\"Usage: !price <ticker>\",\"red\");return}\n  const ticker?= args[0]\n  const client?= service(\"yahoo-market-data\")\n  if(!client?.enabled){reply(\"Market data disabled – check FMP_API_KEY\",\"red\");return}\n  client?.getQuote(ticker)\n    .then(quote=>{\n      if(!quote){reply(\"No data found\",\"red\");return}\n      const embed?= {\n        title?= \"${quote.symbol} - ${quote.shortName}\"\n        description?= \"Price: $${quote.regularMarketPrice?.toFixed(2)}\\nChange: ${quote.regularMarketChangePercent?.toFixed(2)}%\"\n        color?= 0x4CAF50\n      }\n      reply({embeds:[embed]})\n    })\n    .catch(err=>{\n      logWarn(`Invalid ticker \${ticker}: \${err.message}`)\n      reply(\"Failed to fetch price – check ticker\",\"red\")\n    })\n})]\n};function cleanJson(obj){if(typeof obj!==\"object\"||obj===null)return obj;const cleaned={};for(const [k,v] of Object.entries(obj)){if(v&&typeof v===\"object\"&&\"constructor\"in v&&v.constructor.name===\\\"Date\\\"){cleaned[k]=new Date(v)\\\\n}else{cleaned[k]=cleanJson(v)}\\\\n}return cleaned}\n];\n=== ANALYSIS COMPLETE ===